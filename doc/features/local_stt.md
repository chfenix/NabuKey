# æœ¬åœ° STTï¼ˆè¯­éŸ³è½¬æ–‡å­—ï¼‰

> **çŠ¶æ€**: ğŸ“‹ è§„åˆ’ä¸­ | **ä¼˜å…ˆçº§**: â­â­â­â­â­ é«˜ | **å¤æ‚åº¦**: é«˜

## æ¦‚è¿°

ä½¿ç”¨ SenseVoice-Small + Sherpa-ONNX å®ç°æœ¬åœ°è¯­éŸ³è½¬æ–‡å­—ï¼Œé€šè¿‡ HA Conversation API ä¸ Home Assistant äº¤äº’ï¼Œå‡å°‘å¯¹äº‘ç«¯ STT çš„ä¾èµ–ã€‚

## ç³»ç»Ÿæ¶æ„

**å½“å‰æµç¨‹** (éŸ³é¢‘æµæ¨¡å¼):
```
NabuKey â”€â”€(éŸ³é¢‘æµ)â”€â”€â–¶ Home Assistant â”€â”€â–¶ äº‘ç«¯ STT â”€â”€â–¶ æ„å›¾å¤„ç† â”€â”€â–¶ TTS
```

**æ–°æµç¨‹** (æœ¬åœ° STT + Conversation API):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NabuKey (Android)                    Home Assistant                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ 1. å”¤é†’è¯æ£€æµ‹    â”‚                  â”‚                â”‚                â”‚
â”‚  â”‚ 2. å½•åˆ¶éŸ³é¢‘      â”‚                  â”‚                â”‚                â”‚
â”‚  â”‚ 3. æœ¬åœ° STT     â”‚â”€â”€(æ–‡æœ¬)â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ 4. æ„å›¾å¤„ç†    â”‚                â”‚
â”‚  â”‚    (SenseVoice) â”‚  Conversation   â”‚   (LLM/æ„å›¾)   â”‚                â”‚
â”‚  â”‚                 â”‚â—€â”€â”€(æ–‡æœ¬å“åº”)â”€â”€â”€â”€â”‚                â”‚                â”‚
â”‚  â”‚ 5. æœ¬åœ°/è¿œç¨‹ TTS â”‚      API        â”‚                â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€æœ¯é€‰å‹

### STT å¼•æ“

**é€‰å®šæ–¹æ¡ˆ**: SenseVoice-Small + Sherpa-ONNX

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|-----|---------|------|
| **æœ¬åœ° STT** | SenseVoice-Small (Sherpa-ONNX) | 70ms å¤„ç† 10s éŸ³é¢‘ï¼Œä¸­æ–‡ä¼˜åŒ– |
| **HA é€šä¿¡** | Conversation REST API | å‘é€æ–‡æœ¬ï¼Œæ¥æ”¶å“åº” |
| **TTS** | HA TTS URL æˆ–æœ¬åœ° TTS | æ ¹æ®è®¾ç½®é€‰æ‹© |

**SenseVoice ä¼˜åŠ¿**:
- **é€Ÿåº¦**: æ¨ç†å»¶è¿Ÿæä½ï¼Œå¤„ç† 10 ç§’éŸ³é¢‘ä»…éœ€ 70 æ¯«ç§’
- **ç²¾åº¦**: é’ˆå¯¹ä¸­æ–‡å’Œç²¤è¯­ä¼˜åŒ–ï¼Œä¼˜äº Whisper
- **åŠŸèƒ½**: æ”¯æŒè¯­ç§è¯†åˆ«ã€æƒ…æ„Ÿè¯†åˆ«ï¼ˆå¯è”åŠ¨è¡¨æƒ…ç³»ç»Ÿï¼‰
- **é€‚é…**: é€šè¿‡ Sherpa-ONNX å®Œç¾æ”¯æŒ Android

**å¤‡é€‰æ–¹æ¡ˆ**:
| æ–¹æ¡ˆ | æ¨¡å‹ | çŠ¶æ€ |
|-----|------|------|
| Whisper | OpenAI Whisper (tiny/base) | å¤‡é€‰ |
| Vosk | Vosk ç¦»çº¿æ¨¡å‹ | å¤‡é€‰ |

## HA Conversation API

**API è°ƒç”¨ç¤ºä¾‹**:
```http
POST http://<HA_HOST>:8123/api/conversation/process
Authorization: Bearer <LONG_LIVED_TOKEN>
Content-Type: application/json

{
  "text": "æ‰“å¼€å®¢å…ç¯",
  "language": "zh-CN"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "response": {
    "speech": {
      "plain": {
        "speech": "å¥½çš„ï¼Œå·²ä¸ºæ‚¨æ‰“å¼€å®¢å…ç¯",
        "extra_data": null
      }
    }
  },
  "conversation_id": "xxx"
}
```

## å®ç°ä»»åŠ¡

- [ ] é›†æˆ `Sherpa-ONNX` Android SDK
- [ ] ä¸‹è½½å¹¶é›†æˆ `SenseVoice-Small` é‡åŒ–æ¨¡å‹
- [ ] å®ç°éŸ³é¢‘æµåˆ°æ–‡æœ¬çš„è½¬æ¢
- [ ] åˆ›å»º `HomeAssistantApi` ç±»ï¼Œå°è£… Conversation API
- [ ] å®ç°æ–‡æœ¬è¯·æ±‚/å“åº”æµç¨‹
- [ ] åˆ©ç”¨æƒ…æ„Ÿè¯†åˆ«æ•°æ®é©±åŠ¨è¡¨æƒ…å˜åŒ–
- [ ] å®ç°æœ¬åœ° TTS æˆ–ä½¿ç”¨ HA TTS URL
- [ ] æ·»åŠ è®¾ç½®é¡¹ï¼šé€‰æ‹© STT æ¨¡å¼ï¼ˆæœ¬åœ°/äº‘ç«¯ï¼‰ã€HA é…ç½®

## æ–‡ä»¶ç»“æ„

```
app/src/main/java/com/nabukey/
â”œâ”€â”€ stt/
â”‚   â”œâ”€â”€ LocalSTT.kt              # SenseVoice å°è£…
â”‚   â””â”€â”€ STTResult.kt             # STT ç»“æœæ•°æ®ç±»
â”œâ”€â”€ homeassistant/
â”‚   â”œâ”€â”€ HomeAssistantApi.kt      # HA REST API å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ ConversationRequest.kt   # è¯·æ±‚æ•°æ®ç±»
â”‚   â””â”€â”€ ConversationResponse.kt  # å“åº”æ•°æ®ç±»
â””â”€â”€ tts/
    â””â”€â”€ LocalTTS.kt              # (å¯é€‰) æœ¬åœ° TTS
```

## æŠ€æœ¯å¯è¡Œæ€§

| é—®é¢˜ | å¯è¡Œæ€§ | è§£å†³æ–¹æ¡ˆ |
|-----|--------|---------|
| å”¤é†’è¯æ£€æµ‹ | âœ… å·²æœ‰ | TensorFlow Lite æ¨¡å‹ |
| æœ¬åœ° STT | âœ… å¯è¡Œ | SenseVoice + Sherpa-ONNX |
| è°ƒç”¨ HA | âœ… å¯è¡Œ | Conversation REST API |
| è·å–å“åº” | âœ… å¯è¡Œ | JSON å“åº”åŒ…å«æ–‡æœ¬ |
| TTS æ’­æ”¾ | âœ… å¯è¡Œ | æœ¬åœ° TTS æˆ– HA TTS URL |

## ç›¸å…³èµ„æº

- [Sherpa-ONNX GitHub](https://github.com/k2-fsa/sherpa-onnx)
- [SenseVoice ModelScope](https://modelscope.cn/models/iic/SenseVoiceSmall)
- [HA Conversation API æ–‡æ¡£](https://developers.home-assistant.io/docs/intent_conversation_api)
